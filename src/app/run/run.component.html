<mat-sidenav-container fullscreen>
  <mat-sidenav mode="side" position="end" class="sidenav" [opened]="true" class="sidenav">

    <div *ngIf="!runHandler.connected && runHandler.localSlave" class="logs">
      <p *ngFor="let log of runHandler.localSlave.connectionLogs">{{ log }}</p>
    </div>

    <!-- TIMER -->
    <app-run-timer *ngIf="runHandler.connected" [run]="runHandler.run"></app-run-timer>

    <app-run-spectators *ngIf="runHandler.connected && runHandler.run" [spectators]="runHandler.run.spectators" [isHost]="runHandler.lobby?.host?.id === localPlayer.user.id" [userId]="localPlayer.user.id" (onKick)="kickPlayer($event)"></app-run-spectators>
  </mat-sidenav>

  <mat-sidenav-content class="run">
    <!-- HEADER -->
    <div class="run-header">
      <div class="info">
        <p id="version" class="text-in-background" [title]="buildVersion">{{ buildVersion }}</p>
        
        <!-- Menu -->
        <svg class="settings" matTooltip="Open menu" matTooltipPosition="above" (click)="_user.viewSettings = !_user.viewSettings" version="1.0" viewBox="0 0 119.000000 99.000000" preserveAspectRatio="xMidYMid meet">
          <g transform="translate(0.000000,99.000000) scale(0.100000,-0.100000)" stroke="none">
            <path d="M90 905 l0 -85 445 0 445 0 0 85 0 85 -445 0 -445 0 0 -85z"/>
            <path d="M90 505 l0 -85 495 0 495 0 0 85 0 85 -495 0 -495 0 0 -85z"/>
            <path d="M90 105 l0 -85 395 0 395 0 0 85 0 85 -395 0 -395 0 0 -85z"/>
          </g>
        </svg>

        <!-- Back -->
        <svg class="settings" matTooltip="Back to lobby" matTooltipPosition="above" (click)="routeToLobby()" version="1.0" viewBox="0 0 111.000000 104.000000" preserveAspectRatio="xMidYMid meet">
          <g transform="translate(0.000000,104.000000) scale(0.100000,-0.100000)" stroke="none">
            <path d="M285 788 c-148 -139 -270 -257 -270 -263 0 -11 527 -506 546 -513 5 -2 9 80 9 187 l0 191 265 0 265 0 0 135 0 135 -265 0 -265 0 0 190 c0 105 -3 190 -7 190 -5 -1 -129 -114 -278 -252z"/>
          </g>
        </svg>

        <!-- Info -->
        <div class="info-tooltip">
          <svg class="settings" matTooltipClass="tooltip" [matTooltip]="runHandler.info" matTooltipPosition="below" version="1.0" viewBox="0 0 113.000000 122.000000" preserveAspectRatio="xMidYMid meet">
            <g transform="translate(0.000000,122.000000) scale(0.100000,-0.100000)">
              <path d="M422 1150 c-105 -28 -167 -64 -252 -150 -87 -86 -122 -147 -150 -256
              -25 -98 -25 -180 0 -278 28 -109 63 -170 150 -256 86 -87 147 -122 256 -150
              98 -25 180 -25 278 0 109 28 170 63 256 150 87 86 122 147 150 256 25 98 25
              180 0 278 -28 109 -63 170 -150 256 -86 87 -147 122 -256 150 -96 25 -187 25
              -282 0z m298 -139 c109 -41 208 -140 252 -251 31 -78 31 -232 0 -310 -44 -110
              -142 -208 -252 -252 -78 -31 -232 -31 -310 0 -341 135 -376 600 -59 785 102
              60 255 72 369 28z"/>
              <path d="M490 930 l0 -60 70 0 70 0 0 60 0 60 -70 0 -70 0 0 -60z"/>
              <path d="M490 525 l0 -265 70 0 70 0 0 265 0 265 -70 0 -70 0 0 -265z"/>
            </g>
          </svg>
        </div>

      </div>
      <div class="title">
        <div>
          <p *ngIf="runHandler.connected" class="text-in-background" [title]="runHandler.run?.data?.name">{{ runHandler.run?.data?.name }}</p>
        </div>
      </div>
      <div class="logo-container">
        <div class="logo">
          <img src="./assets/teamrun-logo.png" alt="image">
        </div>
      </div>
    </div>

    <div class="run-body" *ngIf="runHandler.connected && runHandler.run">
      <!-- TEAMS -->
      <div class="run-info">
        <div class="run-info-teams">
          <div *ngFor="let team of runHandler.run.teams; let i = index" class="team-cont" [class.team-cont-1row]="runHandler.run.teams.length < 3"[class.team-cont-2row]="runHandler.run.teams.length >= 3">
            
            <p *ngIf="!editingName || team.id !== localPlayer.team?.id" [class.team-name-editable]="team.id === localPlayer.team?.id && localPlayer.state !== playerState.Ready && runHandler.run.timer.runState === runState.Waiting" (click)="editTeamName(team.id)" class="team-name">{{ team.name }}</p>
            <input *ngIf="editingName && team.id === localPlayer.team?.id" (keyup.enter)="newTeamName()" [(ngModel)]="team.name" maxlength="16">
            
            <button *ngIf="runHandler.connected && team.id !== localPlayer.team?.id && localPlayer.state !== playerState.Ready && runHandler.run.timer.runState === runState.Waiting"
              (click)="switchTeam(team.id)">Join</button>
              <div class="team-players">
                <div *ngFor="let player of team.players">
                  <p [class.team-player-disconnected]="player.state === playerState.Disconnected" [class.team-player-ready]="player.state === playerState.Ready && (runHandler.run.timer.runState === runState.Countdown || runHandler.run.timer.runState === runState.Waiting)" [class.team-player-reset]="player.state === playerState.WantsToReset">
                    <img *ngIf="player.user.id === localPlayer.user.id && !_user.trackerConnected" class="run-info-teams-disconnected" src="./assets/other/disconnected.png">
                    <img *ngIf="player.gameState?.onZoomer && (_user.trackerConnected || player.user.id !== localPlayer.user.id)" class="run-info-teams-zoomer" src="./assets/other/zoomer.png">
                    <img *ngIf="player.gameState?.currentLevel && (_user.trackerConnected || player.user.id !== localPlayer.user.id)" class="run-info-teams-level" [src]="'./assets/levels/' + player.gameState.currentLevel + '.png'">
                    <span>{{ player.user.name }}</span>
                    <span class="run-info-teams-cells-cont"><img class="run-info-teams-cells" src="./assets/icons/cell_counter.png">{{ player.cellsCollected }}</span>
                    <span *ngIf="runHandler.lobby?.host?.id === localPlayer.user.id && player.user.id !== localPlayer.user.id && runHandler.run.timer.runState === runState.Waiting" class="run-info-teams-kick" (click)="kickPlayer(player.user)">X</span>
                  </p>
                </div>
              </div>
          </div>
        </div>
        <!-- READY -->
        <div class="run-info-details">
          <button [class.run-info-details-ready]="localPlayer.state == playerState.Ready && runHandler.run.timer.runState === runState.Waiting"
            [disabled]="runHandler.run.timer.runState === runState.Countdown || runHandler.run.timer.runState === runState.Ended || localPlayer.state === playerState.Forfeit || localPlayer.state === playerState.WantsToReset || !_user.trackerConnected || !localPlayer.team"
            (click)="runHandler.run.timer.runState === runState.Started ? forfeit() : toggleReady()">{{ runHandler.run.timer.runState === runState.Started ? "Forfeit" : "Ready" }}</button>

            <button class="run-info-details-reset" 
            [disabled]="runHandler.run.timer.runState !== runState.Started && runHandler.run.timer.runState !== runState.Ended"
            [class.run-info-details-reset-ready]="localPlayer.state === playerState.WantsToReset"
            (click)="toggleReset()">Vote Reset</button>

          <div class="run-info-details-owner">
            <p>Host:<span>{{ runHandler.lobby?.host?.name }}</span></p>
          </div>
        </div>
      </div>


      <!-- RUN STATS -->
      <div class="progress">
        <app-run-splits *ngFor="let team of runHandler.run.teams; let i = index" [team]="team" class="progress-team" [class.progress-team-splitter]="i !== 0"></app-run-splits>
      </div>
    </div>
    <div *ngIf="!runHandler.connected" id="connecting">
      <h1 class="text-in-background">Connecting to Lobby</h1>
      <mat-spinner class="spinner"></mat-spinner>
    </div>

    <div class="backtext">
      <h1>theurn</h1>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>